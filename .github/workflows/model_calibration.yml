name: Scheduled Model Retraining

on: 
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  retrain:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate and Store Timestamp
      id: timestamp
      run: |
        timestamp=$(date '+%Y%m%d%H%M%S')
        echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
        echo "Generated timestamp: $timestamp"

    - name: Create necessary directories
      run: |
        mkdir -p src/data src/models src/metrics src/plots mlruns

    - name: Check File Permissions
      run: |
        ls -l ./src/train_model.py
        ls -l ./src/evaluate_model.py

    - name: Set File Permissions
      run: |
        chmod +x ./src/train_model.py
        chmod +x ./src/evaluate_model.py

    - name: Retrain Model
      run: |
        cd src
        python train_model.py \
          --timestamp "${{ env.TIMESTAMP }}" \
          --model_type gradient_boosting \
          --n_estimators 100 \
          --learning_rate 0.1 \
          --max_depth 3
      continue-on-error: false

    - name: Evaluate Model and Log Metrics
      run: |
        cd src
        python evaluate_model.py \
          --timestamp "${{ env.TIMESTAMP }}" \
          --model_type gradient_boosting
      continue-on-error: false

    - name: List Generated Files
      run: |
        echo "=== Models ==="
        ls -lh src/models/model_${{ env.TIMESTAMP }}_* 2>/dev/null || echo "Model files not found"
        echo ""
        echo "=== Metrics ==="
        ls -lh src/metrics/${{ env.TIMESTAMP }}_* 2>/dev/null || echo "Metrics not found"
        echo ""
        echo "=== Plots ==="
        ls -lh src/plots/*${{ env.TIMESTAMP }}* 2>/dev/null || echo "Plots not found"

    - name: Display Metrics
      run: |
        echo "=== Model Performance Metrics ==="
        cat src/metrics/${{ env.TIMESTAMP }}_metrics.json || echo "Metrics file not found"

    - name: Configure Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

    - name: Commit and Push Changes
      run: |
        # Add generated files
        git add src/models/ src/metrics/ src/plots/ mlruns/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Scheduled: Retrain Housing Price model ${{ env.TIMESTAMP }}
          
          Scheduled retraining executed at $(date)
          Model: Gradient Boosting Regressor
          Timestamp: ${{ env.TIMESTAMP }}
          
          Generated files:
          - Model: src/models/model_${{ env.TIMESTAMP }}_gradient_boosting.joblib
          - Preprocessor: src/models/preprocessor_${{ env.TIMESTAMP }}.pkl
          - Metrics: src/metrics/${{ env.TIMESTAMP }}_metrics.json
          - Plots: src/plots/
          
          Automated by scheduled GitHub Actions workflow"
          
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scheduled-model-${{ env.TIMESTAMP }}
        path: |
          src/models/model_${{ env.TIMESTAMP }}_gradient_boosting.joblib
          src/models/preprocessor_${{ env.TIMESTAMP }}.pkl
          src/metrics/${{ env.TIMESTAMP }}_metrics.json
          src/plots/*.png
        retention-days: 90

    - name: Create Scheduled Training Summary
      run: |
        echo "## Scheduled Model Retraining Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "**Model Type:** Gradient Boosting Regressor" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** Scheduled (Daily at Midnight UTC)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        cat src/metrics/${{ env.TIMESTAMP }}_metrics.json 2>/dev/null || echo "{\"error\": \"Metrics not found\"}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY