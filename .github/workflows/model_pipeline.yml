# name: Housing Price Model Pipeline

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:  # Allow manual triggering

# jobs:
#   train-and-deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: '3.9'

#     - name: Cache dependencies
#       uses: actions/cache@v3
#       with:
#         path: ~/.cache/pip
#         key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
#         restore-keys: |
#           ${{ runner.os }}-pip-

#     - name: Install dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt

#     - name: Generate Timestamp
#       id: timestamp
#       run: |
#         timestamp=$(date '+%Y%m%d%H%M%S')
#         echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
#         echo "timestamp=$timestamp" >> $GITHUB_OUTPUT

#     - name: Create necessary directories
#       run: |
#         mkdir -p data models metrics plots mlruns

#     - name: Train Model
#       run: |
#         cd src
#         python train_model.py --timestamp "${{ env.TIMESTAMP }}" --model_type gradient_boosting --n_estimators 100 --learning_rate 0.1 --max_depth 3
#       continue-on-error: false

#     - name: Evaluate Model
#       run: |
#         cd src
#         python evaluate_model.py --timestamp "${{ env.TIMESTAMP }}" --model_type gradient_boosting
#       continue-on-error: false

#     - name: List generated files
#       run: |
#         echo "=== Models ==="
#         ls -lh models/
#         echo "=== Metrics ==="
#         ls -lh metrics/
#         echo "=== Plots ==="
#         ls -lh plots/ || echo "No plots directory"

#     - name: Move artifacts to correct locations
#       run: |
#         # Move model file if in root
#         if [ -f "model_${TIMESTAMP}_gradient_boosting.joblib" ]; then
#           mv model_${TIMESTAMP}_gradient_boosting.joblib models/
#         fi
        
#         # Ensure metrics are in correct location
#         if [ -f "${TIMESTAMP}_metrics.json" ]; then
#           mv ${TIMESTAMP}_metrics.json metrics/
#         fi

#     - name: Display Metrics
#       run: |
#         echo "=== Model Performance Metrics ==="
#         cat metrics/${TIMESTAMP}_metrics.json

#     - name: Configure Git
#       run: |
#         git config --global user.email "github-actions[bot]@users.noreply.github.com"
#         git config --global user.name "github-actions[bot]"

#     - name: Commit and Push Changes
#       run: |
#         git add models/ metrics/ plots/ || true
#         git add mlruns/ || true
        
#         # Check if there are changes to commit
#         if git diff --staged --quiet; then
#           echo "No changes to commit"
#         else
#           git commit -m "Auto: Train model ${TIMESTAMP} - Gradient Boosting"
#           git push
#         fi
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#     - name: Upload Model Artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: model-${{ env.TIMESTAMP }}
#         path: |
#           models/model_${{ env.TIMESTAMP }}_gradient_boosting.joblib
#           models/preprocessor_${{ env.TIMESTAMP }}.pkl
#           metrics/${{ env.TIMESTAMP }}_metrics.json
#           plots/

#     - name: Create Release Summary
#       run: |
#         echo "## Housing Price Model Training Summary" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "**Timestamp:** ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
#         echo "**Model Type:** Gradient Boosting Regressor" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
#         echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
#         cat metrics/${{ env.TIMESTAMP }}_metrics.json >> $GITHUB_STEP_SUMMARY
#         echo "\`\`\`" >> $GITHUB_STEP_SUMMARY


name: Housing Price Model Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate Timestamp
      id: timestamp
      run: |
        timestamp=$(date '+%Y%m%d%H%M%S')
        echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT

    - name: Create necessary directories
      run: |
        mkdir -p src/data src/models src/metrics src/plots mlruns

    - name: Train Model
      run: |
        cd src
        python train_model.py \
          --timestamp "${{ env.TIMESTAMP }}" \
          --model_type gradient_boosting \
          --n_estimators 100 \
          --learning_rate 0.1 \
          --max_depth 3
      continue-on-error: false

    - name: Evaluate Model
      run: |
        cd src
        python evaluate_model.py \
          --timestamp "${{ env.TIMESTAMP }}" \
          --model_type gradient_boosting
      continue-on-error: false

    - name: List generated files
      run: |
        echo "=== Models ==="
        ls -lh src/models/ 2>/dev/null || echo "No models directory"
        echo ""
        echo "=== Metrics ==="
        ls -lh src/metrics/ 2>/dev/null || echo "No metrics directory"
        echo ""
        echo "=== Plots ==="
        ls -lh src/plots/ 2>/dev/null || echo "No plots directory"

    - name: Display Metrics
      run: |
        echo "=== Model Performance Metrics ==="
        cat src/metrics/${TIMESTAMP}_metrics.json || echo "Metrics file not found"

    - name: Configure Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

    - name: Commit and Push Changes
      run: |
        git add src/models/ src/metrics/ src/plots/ mlruns/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m " Auto: Train Housing Price model ${TIMESTAMP}

          Model: Gradient Boosting Regressor
          Timestamp: ${TIMESTAMP}
          
          Generated files:
          - Model: src/models/model_${TIMESTAMP}_gradient_boosting.joblib
          - Preprocessor: src/models/preprocessor_${TIMESTAMP}.pkl
          - Metrics: src/metrics/${TIMESTAMP}_metrics.json
          - Plots: src/plots/
          
          Automated by GitHub Actions"
          
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-${{ env.TIMESTAMP }}
        path: |
          src/models/model_${{ env.TIMESTAMP }}_gradient_boosting.joblib
          src/models/preprocessor_${{ env.TIMESTAMP }}.pkl
          src/metrics/${{ env.TIMESTAMP }}_metrics.json
          src/plots/*.png
        retention-days: 30

    - name: Create Release Summary
      run: |
        echo "## Housing Price Model Training Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "**Model Type:** Gradient Boosting Regressor" >> $GITHUB_STEP_SUMMARY
        echo "**Dataset:** California Housing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        cat src/metrics/${{ env.TIMESTAMP }}_metrics.json 2>/dev/null || echo "{\"error\": \"Metrics not found\"}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Model file: \`src/models/model_${{ env.TIMESTAMP }}_gradient_boosting.joblib\`" >> $GITHUB_STEP_SUMMARY
        echo "- Preprocessor: \`src/models/preprocessor_${{ env.TIMESTAMP }}.pkl\`" >> $GITHUB_STEP_SUMMARY
        echo "- Metrics: \`src/metrics/${{ env.TIMESTAMP }}_metrics.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- Evaluation plots: \`src/plots/\`" >> $GITHUB_STEP_SUMMARY